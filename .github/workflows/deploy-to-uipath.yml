name: Deploy UiPath Package to Orchestrator (Windows)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: windows-latest

    steps:
      # --------------------------------------------
      # Checkout repository
      # --------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------
      # Download and Extract UiPath CLI
      # --------------------------------------------
      - name: Setup UiPath CLI
        id: setup_cli
        shell: pwsh
        run: |
          $setup = Join-Path $env:GITHUB_WORKSPACE "setup"
          New-Item -ItemType Directory -Force -Path $setup | Out-Null

          $nupkg = "$setup\UiPath.CLI.Windows.25.4.9364.27216.nupkg"
          $url   = "https://raw.githubusercontent.com/Peters4Bots/UipathSetup/main/UiPath.CLI.Windows.25.4.9364.27216.nupkg"

          Write-Host "Downloading UiPath CLI package from: $url"
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Headers @{ Accept = 'application/octet-stream' } -Uri $url -OutFile $nupkg

          Write-Host "Download complete: $nupkg"
          Get-Item $nupkg | Format-List Name, Length, LastWriteTime

          # Validate file header to ensure it's a ZIP/NUPKG
          

          # Extract UiPath CLI
          $toolPath = Join-Path $env:USERPROFILE "uipath-cli-tools"
          New-Item -ItemType Directory -Force -Path $toolPath | Out-Null
          Write-Host "Extracting CLI from nupkg..."
          Expand-Archive -LiteralPath $nupkg -DestinationPath $toolPath -Force

          # Locate uipcli.exe
          Write-Host "Searching for uipcli.exe..."
          $exe = Get-ChildItem -Path $toolPath -Recurse -Filter "uipcli.exe" | Select-Object -First 1
          if (-not $exe) { throw "uipcli.exe not found inside extracted package." }

          Write-Host "✅ Found UiPath CLI at: $($exe.FullName)"
          & "$($exe.FullName)" --version

          # expose path as a step output
          "uipcli_path=$($exe.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      # --------------------------------------------
      # Show available CLI commands
      # --------------------------------------------
      - name: Show UiPath CLI commands
        shell: pwsh
        run: |
          $uipcli = "${{ steps.setup_cli.outputs.uipcli_path }}"
          Write-Host "Available UiPath CLI commands:"
          & "$uipcli" --help
          
      # --------------------------------------------
      # Pack UiPath Project
      # --------------------------------------------
      - name: Pack UiPath Project
        shell: pwsh
        run: |
          $uipcli = "${{ steps.setup_cli.outputs.uipcli_path }}"
          if (-not (Test-Path $uipcli)) { throw "UiPath CLI path not found: $uipcli" }

          $outDir = Join-Path "${{ github.workspace }}" "output"
          New-Item -ItemType Directory -Path $outDir -Force | Out-Null

          Write-Host "Packing project with CLI: $uipcli"
          & "$uipcli" package pack "${{ github.workspace }}" --output "$outDir"
          Write-Host "✅ Packaging complete."

      # --------------------------------------------
      # Deploy UiPath Package to Orchestrator
      # --------------------------------------------
      - name: Deploy UiPath Package to Orchestrator
        shell: pwsh
        env:
          UIP_ORCH_URL: "https://cloud.uipath.com"
          UIP_ORCH_ACC: "helpathomev2"
          UIP_ORCH_TENANT: "DefaultTenant"
          UIP_CLIENT_ID: "a4951225-8912-487a-aac5-98ab5a568ac9"
          UIP_USER_KEY: ${{ secrets.UIP_USER_KEY }}
        run: |
          $uipcli = "${{ steps.setup_cli.outputs.uipcli_path }}"
          $output = Join-Path "${{ github.workspace }}" "output"
          if (-not (Test-Path $output)) { throw "Output folder not found: $output" }

          $package = Get-ChildItem $output -Filter *.nupkg | Select-Object -First 1
          if (-not $package) { throw "No package found in output folder." }

          Write-Host "Deploying package: $($package.FullName)"
          & "$uipcli" package deploy `
            "$($package.FullName)" `
            --orchestratorUrl "$env:UIP_ORCH_URL" `
            --account        "$env:UIP_ORCH_ACC" `
            --tenant         "$env:UIP_ORCH_TENANT" `
            --clientId       "$env:UIP_CLIENT_ID" `
            --userKey        "$env:UIP_USER_KEY" `
            --folder         "RCM"

          Write-Host "✅ Deployment complete."

      # --------------------------------------------
      # Upload artifacts for traceability
      # --------------------------------------------
      - name: Upload Packed Artifact
        uses: actions/upload-artifact@v4
        with:
          name: UiPath_Package_Output
          path: ${{ github.workspace }}\output
